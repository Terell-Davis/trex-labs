#SPDX-License-Identifier: MIT-0
---
# tasks file for plex
- name:  Makes sure sudo is installed
  apt:
    name: sudo
    state: present
    update_cache: true

- name:  Install gpg for PlexMediaServer
  apt:
    name: gpg
    state: present
    update_cache: true

- name: Check for plex.gpg exists
  stat:
    path: /etc/apt/trusted.gpg.d/plex.gpg
  register: stat_result

- name: Download Repository Key
  shell: "wget -O- https://downloads.plex.tv/plex-keys/PlexSign.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/plex.gpg"
  when: not stat_result.stat.exists

- name: Add specified repository into sources list
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/trusted.gpg.d/plex.gpg] https://downloads.plex.tv/repo/deb public main"
    state: present

- name: Install Plex Server
  apt:
    name: plexmediaserver
    state: present
    update_cache: true

- name: Start and enable Plex service
  service:
    name: plexmediaserver
    state: started
    enabled: true

- name: Enable and start plex
  ansible.builtin.systemd:
    name: plexmediaserver.service
    state: started
    enabled: true
  changed_when: false
